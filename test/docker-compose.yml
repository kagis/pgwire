version: '3.4'
services:
  test:
    build: .
    environment:
      POSTGRES: postgres://postgres@postgres:5432
    depends_on:
      - postgres
      - pgbouncer
    working_dir: /opt/pgwire
    volumes: ['..:/opt/pgwire']

  repl:
    image: node:11-alpine
    command: sh -c 'sleep 5 && node test/repl.js'
    depends_on: [postgres, pgbouncer]
    working_dir: /opt/pgwire
    volumes: ['..:/opt/pgwire']

  psql:
    image: postgres:11-alpine
    depends_on: [postgres]
    command: sh -c 'sleep 5 && psql postgres://postgres@postgres:5432/postgres'

  postgres:
    build:
      context: .
      dockerfile: pg.dockerfile

  pgbouncer:
    image: brainsam/pgbouncer
    environment:
      DB_HOST: postgres
      DB_USER: postgres
